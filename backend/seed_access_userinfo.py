# scripts/seed_access_userinfo.py
import argparse
import re
from flask import Flask
from sqlalchemy import text
from app.extensions import db
from app.models.access import AccessUserInfo
from datetime import datetime

# --- paste or load your mapping blob here (the big USERINFO list you gave) ---
MAPPING_BLOB = """
USERINFO
USERID Badgenumber 2 9022 3 9004 4 1202 11 987654 12 613 20 7044 21 1273 22 1079 23 849 24 1342 25 1376 26 1360 27 8 33 39 34 1199 35 831 36 319 37 91 38 992 39 147 40 1387 41 1042 42 594 44 9013 45 517 46 229 47 1368 48 457 49 1181 50 627 51 844 52 792 53 398 54 90 56 754 57 1174 58 396 59 482 60 197 61 1015 62 224 63 9045 64 1274 65 1396 68 445 69 430 70 941 72 1344 73 124 74 380 75 808 76 793 77 928 80 1021 83 7049 84 581 85 1083 86 993 87 549 88 1205 89 196 90 211 91 364 92 70 93 1319 94 1192 96 159 97 1294 98 505 99 623 100 1394 102 29 103 1188 104 37 105 1336 106 149 107 270 108 1010 109 311 111 13 112 417 113 1375 114 730 115 1222 116 570 117 784 118 361 120 1323 121 65 122 9007 123 142 124 312 125 473 126 871 127 1038 128 1378 129 819 130 945 131 749 132 123 133 191 134 654 135 553 136 238 137 529 138 916 139 498 140 981 141 7056 142 8009 143 333 144 912 145 762 146 688 147 763 148 599 149 840 150 662 151 739 152 342 153 1132 154 129 155 506 156 1031 157 358 158 477 159 1201 160 250 161 557 162 1189 163 641 164 1326 165 1219 166 1078 167 1345 168 1091 169 817 170 460 171 632 172 26 173 1007 174 135 175 227 176 852 177 61 178 686 179 855 180 108 181 1168 182 86 183 62 184 87 185 172 186 222 187 261 188 272 189 466 190 1012 191 731 192 219 193 344 194 468 195 660 196 759 197 771 198 866 200 375 201 742 202 1041 203 181 204 1221 205 1190 206 14 207 525 208 97 209 162 210 9043 211 19 212 715 213 341 214 975 215 569 216 305 217 854 218 737 219 1143 220 107 221 362 222 1388 223 1135 224 285 225 7072 226 635 227 109 228 534 229 1306 230 1120 231 1029 232 1367 233 266 234 173 235 650 236 598 237 452 238 507 240 1071 242 1362 243 853 244 415 245 856 246 143 247 1365 249 1033 251 494 252 1203 253 1138 254 1355 256 818 257 1352 258 584 259 630 260 1246 262 259 263 510 264 1823 265 1253 266 475 267 1131 269 672 270 1301 271 915 272 9052 273 827 274 1335 275 198 276 736 277 582 278 451 279 136 280 1118 281 556 282 271 283 648 284 889 285 979 287 384 288 615 289 383 291 1030 292 141 293 777 294 914 295 268 296 386 297 1035 298 674 299 299 300 1305 302 1177 303 1182 304 1363 305 231 306 9023 307 335 308 377 309 1013 310 47 311 9044 312 206 313 832 314 1084 316 933 317 1283 318 7074 319 959693 320 111111111 322 1000 323 500 324 119 325 7052 326 225 327 887 328 1400 329 911 331 1139 332 1140 333 1315 334 1371 335 280 336 658 337 1377 338 395 339 382 340 385 341 713 342 841 343 1153 344 1232 345 949 346 1264 347 960 348 835 349 680 350 568 352 23 353 668 354 89 355 17 356 104 357 9019 358 1252 359 345 360 215 361 22 362 150 363 168 364 493 365 608 366 618 367 646 368 711 369 738 370 745 372 961 373 1001 374 9026 375 843 376 492 377 1024 378 378 379 9028 380 509 381 882 382 652 383 503 384 1278 385 1160 386 907 387 432 388 411 389 1009 390 563 391 387 392 1285 393 9012 394 490 395 721 396 248 397 677 398 25 399 667 400 1414 401 696 402 972 403 864 404 629 405 576 406 656 407 57 408 371 409 1036 410 1386 411 7064 412 7065 413 426 414 376 415 7067 416 7068 417 1308 418 9030 419 653 420 369 421 878 422 180 423 9003 424 1347 425 1349 426 161 427 7053 428 1357 430 1027 431 7006 432 1356 433 1392 434 1313 435 7063 437 834 438 1391 439 7066 440 9031 441 188 442 508 443 357 444 1288 445 9036 446 719 447 390 448 659 449 757 450 538 451 1236 452 265 453 1296 454 706 455 1119 456 670 457 1327 458 761 460 1419 461 732 462 7041 463 1299 464 1421 465 7077 466 1415 467 1348 468 1220 469 639 470 884 471 968 472 1022 473 1037 474 932 475 520 476 326 477 671 478 9034 479 7059 480 1389 481 223 482 9008 483 860 484 905 485 567 486 723 488 1162 489 894 490 1116 491 183 492 370 493 393 494 846 495 922 496 890 497 946 498 7005 499 1309 501 7004 502 940 503 934 504 7001 505 833 506 966 507 939 508 881 509 1424 510 343 511 1399 512 1136 513 325 514 1346 515 1178 516 977 517 355 518 436 519 1126 520 751 522 322 523 872 524 1279 525 9050 526 545 527 681 528 828 530 195 531 1417 532 260 533 294 534 583 535 1002 536 586 537 1008 538 695 539 132 540 146 541 591 542 604 543 663 544 790 545 638 546 228 547 9005 548 778 549 746 550 1329 551 755 552 769 553 158 554 122 555 965 556 936 557 558 558 574 559 144 560 1053 561 1233 562 1420 563 788 564 575 565 1361 566 1019 567 826 569 1099 570 372 571 7058 572 794 573 36 574 1216 575 1034 576 1062 577 1003 578 209 579 288 580 480 581 1425 582 275 583 257 584 895 585 527 586 424 587 127 588 625 589 959 590 454 591 606 592 595 593 669 594 106 595 1110 596 9032 597 323 598 99 599 1307 600 985 601 805 602 1241 603 1014 604 747 606 373 607 930 608 1025 609 1303 610 11 611 750 612 472 613 116 614 651 615 600 616 789 617 700 618 111 619 1337 620 799 621 334 622 339 623 986 624 9033 625 264 626 565 627 153 628 631 629 404 630 622 631 657 632 845 633 955 634 9011 635 647 636 791 637 837 638 1032 639 1075 640 605 641 935 642 7033 643 780 644 1413 645 873 646 775 647 448 648 785 649 953 650 391 651 801 652 573 653 157 654 1063 655 1370 656 1351 657 297 658 714 659 664 660 1416 661 425 662 768 663 1663 664 1436 665 1372 666 1290 667 210 668 772 669 155 670 753 671 1343 672 350 673 1210 674 1262 675 7042 676 973 677 1247 678 1406 679 365 680 7055 681 9047 682 519 683 320 684 7048 685 958 686 403 688 1238 689 774 690 7045 691 7070 692 571 693 554 694 1427 695 948 696 189 697 1412 698 470 699 787 700 281 702 621 703 902 704 1193 705 235 706 1089 708 461 709 7078 710 7073 711 530 713 314 714 7054 716 1390 717 145 718 689 719 838 720 5 721 896 722 588 723 1429 724 693 725 8008 726 115 727 156 728 1366 729 1409 731 300 732 298 733 609 734 1411 735 277 736 1076 737 679 738 340 739 504 740 684 741 602 742 1401 744 9014 745 823 746 105 747 1439 748 1226 749 431 750 1257 751 9020 752 100 753 562 759 1332 760 9037 761 1324 765 282 766 247 767 251 768 923 769 7079 775 2 776 1440 777 1050 778 760 779 909 780 125 781 130 782 499 783 366 784 744 785 518 786 1270 787 283 789 304 796 1146 797 1407 798 1354 799 893 800 349 801 1405 802 1330 803 1369 804 1350 807 1171 808 10 809 1364 810 692 811 170 812 1448 813 980 814 1272 815 918 816 1149 819 46 820 1449 821 848 822 661 823 476 824 839 825 1092 826 12 827 368 828 112 829 295 830 237 831 1155 832 682 833 1393 834 566 835 649 836 740 837 691 838 842 839 226 840 9021 841 705 842 167 843 633 844 1300 845 994 846 597 847 1006 848 455 849 666 850 462 851 950 852 836 853 704 854 7060 855 974 856 701 857 1402 858 710 859 220 860 491 861 703 862 675 863 879 864 783 865 1453 866 7081 867 1284 868 394 869 938 870 897 871 1322 872 1339 873 1170 874 242 875 1137 876 303 877 337 878 439 879 1381 880 929 881 501 882 1311 883 1317 884 92 885 274 886 240 887 624 888 7050 889 707 890 857 891 942 892 1005 893 678 894 683 895 114 896 367 898 1447 899 614 900 820 901 1320 902 103 903 1150 905 643 907 137 908 1433 909 1223 912 185 913 245 914 987 916 1965 917 1443 918 1454 919 1774 920 1408 922 1265 923 405 924 287 925 359 926 453 927 253 928 969 929 1428 930 182 931 886 932 868 933 1237 934 830 935 1432 936 673 937 318 938 786 939 1073 940 1457 941 239 942 392 943 550 944 456 945 1333 946 7002 947 891 948 1455 949 1906 950 756 951 249 952 293 953 328 954 572 955 163 956 1445 958 1458 959 1446 960 988 961 578 963 1018 966 1444 967 1459 968 1460 969 1456 970 202 971 962 972 1093 973 1115 975 7075 977 9015 978 1318 979 7051 981 354 982 883 983 1028 986 1464 987 321 988 1023 991 1465 992 1 993 1422 994 1462 998 917 1000 626 1001 489 1003 458 1004 521 1005 1469 1006 1470 1007 645 1008 1358 1009 9056 1010 7 1011 7087 1012 1379 1014 513 1016 1338 1017 1107 1018 496 1020 52 1021 1373 1022 874 1023 464 1024 1218 1025 474 1026 1163 1027 91204 1028 1258 1029 925 1030 374 1031 798 1032 1183 1033 134 1034 21 1035 221 1036 892 1037 256 1038 1142 1039 1212 1040 537 1041 1231 1045 1471 1046 1472 1047 991 1048 990 1049 1473 1050 7088 1052 7007 1053 1245 1054 7069 1055 9039 1056 900 1057 876 1058 991233 1059 7024 1060 95286 1061 727 1062 438 1063 1468 1064 83 1065 388 1066 7008 1067 31 1068 240917610 1069 1061 1070 1474 1071 76 1072 7089 1073 234 1074 1504 1075 1514 1076 1480 1077 1503 1078 1479 1079 1513 1080 1499 1081 1517 1082 1478 1083 1486 1084 1511 1085 120007 1086 1512 1087 1508 1088 1506 1089 1515 1090 1498 1092 1487 1094 1501 1095 1493 1096 1482 1097 1492 1099 1507 1100 1500 1102 1481 1103 1484 1104 363 1105 1495 1106 1488 1107 1476 1108 1509 1109 1200 1110 1496 1111 797 1112 590 1114 984 1115 1461 1116 8007 1118 3 1119 4 1121 1983 1124 63 1125 232 1126 770 1127 32 1128 516 1129 179 1135 1754 1136 1559 1137 1537 1139 1545 1140 1521 1141 1531 1142 1546 1143 1524 1144 1554 1145 1535 1146 1544 1147 1520 1148 1532 1149 1558 1150 1551 1151 1526 1152 1534 1154 1528 1156 1538 1159 1541 1160 1557 1161 1547 1162 1543 1165 1556 1167 1204 1168 208 1169 1271 1170 66 1172 1224 1173 816 1174 1125 1175 7071 1176 1293 1177 1058 1178 1423 1179 1128 1180 1287 1181 1426 1182 1208 1183 7062 1184 1185 1185 1129 1186 1090 1187 1403 1189 1353 1190 1988 1191 982 1192 528 1193 406 1194 1314 1197 1548 1198 1410 1199 125200 1200 1562 1201 898 1202 1563 1203 40936 1204 1485 1205 1530 1206 1539 1207 1566 1208 1302 1209 515 1210 1404 1211 117 1212 628 1213 41 1214 169 1215 1494 1216 1567 1217 1569 1218 1571 1219 1310 1220 88 1221 1570 1222 1574 1223 1572 1224 1577 1225 1576 1226 1578 1227 1573 1228 1579 1229 1463 1230 927 1231 1466 1232 1385 1233 1159 1234 1331 1235 72 1236 963 1237 410 1238 592 1239 748 1240 926 1241 954 1242 1467 1243 1383 1244 776 1245 741 1246 796 1247 1114 1248 1055 1249 48 1250 9054 1252 1581 1253 1594 1254 1601 1255 1609 1256 1604 1257 1590 1258 1610 1259 1584 1260 1575 1261 1599 1262 1608 1263 1597 1264 1602 1265 1607 1266 1589 1267 1583 1268 1615 1269 1616 1270 1611 1271 1617 1272 1618 1273 1620 1274 1642 1275 1637 1276 1622 1277 2148 1280 1647 1281 1648 1282 1621 1283 1632 1284 1613 1285 1634 1286 687 1287 1600 1288 1640 1289 1585 1290 1628 1291 1641 1292 1631 1293 1625 1294 1614 1295 1638 1296 1606 1297 1636 1298 1644 1299 1623 1300 1646 1301 1630 1303 1633 1304 1639 1305 1643 1306 1645 1307 1619 1308 1591 1309 1582 1310 1626 1311 1649 1312 1650 1313 1418 1314 1629 1315 205 1316 1395 1317 1552 1318 1627 1319 1592 1321 1654 1322 869 1323 1653 1324 1660 1325 1680 1326 1661 1327 1679 1328 1670 1329 1677 1330 1671 1331 1668 1332 1669 1333 1664 1334 1658 1335 1659 1336 1662 1337 1678 1338 1674 1339 1675 1340 1681 1341 353 1342 45 1343 1673 1344 944 1345 1676 1346 709 1347 1672 1349 1096 1350 1292 1351 1652 1352 1144 1353 15 1354 1687 1355 1694 1356 1690 1357 1688 1358 1691 1359 1397 1361 850 1362 111367 1363 1477 1364 1533 1365 1553 1366 1624 1367 1587 1368 1695 1369 1635 1370 1523 1371 1522 1372 1516 1373 1542 1374 1525 1375 1693 1376 1612
"""

def parse_blob_to_pairs(blob_text):
    tokens = re.split(r'\s+', blob_text.strip())
    start = 0
    if tokens and tokens[0].upper().startswith("USERINFO"):
        start = min(3, len(tokens))
    pairs = []
    i = start
    while i + 1 < len(tokens):
        uid = tokens[i]
        badge = tokens[i + 1]
        pairs.append((str(uid).strip(), str(badge).strip()))
        i += 2
    return pairs

def seed(sn=None, drop=False, dry_run=True):
    app = Flask(__name__)
    app.config.from_object("app.config.Config")
    with app.app_context():
        db.init_app(app)

        if drop:
            # Use raw connection + FK toggle as in seed_branches.py
            with db.engine.connect() as conn:
                conn.execute(text("SET FOREIGN_KEY_CHECKS = 0;"))
                AccessUserInfo.__table__.drop(bind=conn, checkfirst=True)
                AccessUserInfo.__table__.create(bind=conn)
                conn.execute(text("SET FOREIGN_KEY_CHECKS = 1;"))
            print("Dropped + recreated access_userinfo table.")

        pairs = parse_blob_to_pairs(MAPPING_BLOB)
        print(f"Parsed {len(pairs)} pairs.")

        # filter out blank badge tokens and normalize strings
        pairs = [(u, b) for (u, b) in pairs if b and b.strip() != '']
        if not pairs:
            print("No valid pairs found after filtering.")
            return

        # Build set of existing Badgenumbers (optionally scoped by sn if you want)
        q = db.session.query(AccessUserInfo.Badgenumber)
        if sn:
            q = q.filter(AccessUserInfo.sn == sn)
        existing = {str(r[0]) for r in q.all()}

        to_insert = []
        for uid, badge in pairs:
            badge_s = str(badge).strip()
            if badge_s in existing:
                continue
            rec = {
                "USERID": str(uid).strip(),
                "Badgenumber": badge_s,
                "sn": sn,
                "source": "seed_script",
                "created_at": datetime.utcnow()
            }
            to_insert.append(rec)

        print(f"Existing badges (skipped): {len(existing)}")
        print(f"New rows to insert: {len(to_insert)}")

        if dry_run:
            print("Dry run - not inserting.")
            for r in to_insert[:10]:
                print(r)
            return

        if to_insert:
            try:
                db.session.bulk_insert_mappings(AccessUserInfo, to_insert)
                db.session.commit()
                print(f"Inserted {len(to_insert)} rows.")
            except Exception as e:
                db.session.rollback()
                print("Bulk insert failed:", e)
                # fallback per-row
                inserted = 0
                for r in to_insert:
                    try:
                        obj = AccessUserInfo(**r)
                        db.session.add(obj)
                        db.session.commit()
                        inserted += 1
                    except Exception as e2:
                        db.session.rollback()
                        print("Row insert failed:", r, e2)
                print(f"Inserted {inserted} rows with fallback.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--sn", help="device serial to set on rows", default=None)
    parser.add_argument("--drop", action="store_true", help="drop + create table before inserting")
    parser.add_argument("--dry-run", action="store_true", help="show what would be inserted and exit")
    args = parser.parse_args()
    seed(sn=args.sn, drop=args.drop, dry_run=args.dry_run)
